<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Audio Dialogue Generator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,200..1000;1,200..1000&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Nunito", sans-serif;
        text-align: center;
        padding: 40px;
        background-color: #f8f8f8;
      }
      h1 {
        font-size: 28px;
        margin-bottom: 20px;
      }
      textarea {
        width: 100%;
        max-width: 600px;
        height: 200px;
        padding: 10px;
        font-size: 16px;
        border-radius: 8px;
        border: 1px solid #ccc;
        resize: vertical;
        white-space: pre-line;

        padding: 10px;
      }
      .tooltip {
        position: relative;
        cursor: pointer;
        display: inline-block;
      }

      .tooltiptext {
        visibility: hidden;
        background-color: #444;
        color: #fff;
        text-align: center;
        border-radius: 4px;
        padding: 5px 8px;
        position: absolute;
        z-index: 1;
        top: -5px;
        left: 110%;
        white-space: nowrap;
        font-size: 13px;
        opacity: 0;
        transition: opacity 0.2s ease-in-out;
      }

      .tooltip:hover .tooltiptext {
        visibility: visible;
        opacity: 1;
      }
      select {
        margin-top: 10px;
        padding: 8px;
        font-size: 14px;
        border-radius: 6px;
        border: 1px solid #ccc;
      }
      button {
        margin-top: 20px;
        font-size: 16px;
        padding: 12px 24px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
      }
      button:hover {
        background-color: #0056b3;
      }
      audio {
        margin-top: 25px;
        width: 100%;
        max-width: 600px;
        margin: auto;
      }
      .loading {
        margin-top: 20px;
        font-style: italic;
        color: #666;
      }
      .preview {
        margin-top: 30px;
        max-width: 600px;
        margin-left: auto;
        margin-right: auto;
        text-align: left;
        background: #fff;
        border-radius: 8px;
        padding: 10px;
        box-shadow: 0 0 6px rgba(0, 0, 0, 0.1);
      }
      .line {
        display: flex;
        align-items: flex-start;
        gap: 10px;
        margin-bottom: 10px;
      }
      .avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background-color: #007bff;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-family: sans-serif;
      }
      .bubble {
        background: #e4e6eb;
        padding: 8px 12px;
        border-radius: 8px;
        max-width: 80%;
        line-height: 1.4;
      }
    </style>
  </head>
  <body>
    <h1>üéôÔ∏è Audio Dialogue Generator</h1>
    <div id="dialogueWrapper">
      <textarea
        id="dialogueBox"
        rows="10"
        placeholder="‚úçÔ∏è Enter either a prompt or a full dialogue.
        üîπ Prompt example:
        Write a short conversation about booking a hotel room with name spelling.
        üîπ Dialogue example:
        Hello, how can I help you?
        I'd like to book a room for two nights."
      ></textarea>
    </div>
    <button
      id="editScriptBtn"
      onclick="showScriptInput()"
      style="display: none"
    >
      ‚úèÔ∏è Edit Script
    </button>

    <br />
    <label>üßë Gi·ªçng nam: </label>
    <select id="voiceMale">
      <option value="en-US-GuyNeural" selected>Guy</option>
      <option value="en-US-ChristopherNeural">Christopher</option>
      <option value="en-US-EricNeural">Eric</option>
    </select>

    <label>üë© Gi·ªçng n·ªØ: </label>
    <select id="voiceFemale">
      <option value="en-US-JennyNeural" selected>Jenny</option>
      <option value="en-US-SaraNeural">Sara</option>
      <option value="en-US-MichelleNeural">Michelle</option>
    </select>

    <br />
    <button onclick="generateAudio()">üîä Generate Audio</button>
    <button onclick="generateIELTSTable()">üìÑ Generate IELTS Table</button>
    <button onclick="togglePreview()">üìù Show Script Preview</button>

    <div class="loading" id="loadingMsg" style="display: none">
      üîÑ Processing, please wait...
    </div>

    <audio id="audioPlayer" controls style="display: none"></audio>
    <div class="preview" id="scriptPreview" style="display: none"></div>
    <div class="preview" id="ieltsTable"></div>

    <script>
      function togglePreview() {
        const preview = document.getElementById("scriptPreview");
        preview.style.display =
          preview.style.display === "none" ? "block" : "none";
      }

      async function generateAudio() {
        const dialogueWrapper = document.getElementById("dialogueWrapper");
        const editBtn = document.getElementById("editScriptBtn");
        const textarea = document.getElementById("dialogueBox");
        const text = textarea.value.trim();
        const previewDiv = document.getElementById("scriptPreview");
        const loading = document.getElementById("loadingMsg");
        const audio = document.getElementById("audioPlayer");

        if (!text) return alert("Please enter a prompt or dialogue.");

        // ·∫®n textarea, hi·ªán n√∫t s·ª≠a
        dialogueWrapper.style.display = "none";
        editBtn.style.display = "inline-block";

        // Show loading
        loading.style.display = "block";
        audio.style.display = "none";

        const voiceMale = document.getElementById("voiceMale").value;
        const voiceFemale = document.getElementById("voiceFemale").value;
        const isPrompt = !text.includes("\n");

        try {
          const res = await fetch(
            "https://ielts-part1.onrender.com/api/generate",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                mode: isPrompt ? "prompt" : "script",
                script: text,
                maleVoice: voiceMale,
                femaleVoice: voiceFemale,
              }),
            }
          );

          loading.style.display = "none";

          if (!res.ok) {
            alert("‚ùå Failed to generate audio.");
            return;
          }

          const data = await res.json();
          const { script, audio: audioBase64 } = data;

          // üëâ Convert base64 to audio Blob
          const binary = atob(audioBase64);
          const bytes = new Uint8Array(binary.length);
          for (let i = 0; i < binary.length; i++) {
            bytes[i] = binary.charCodeAt(i);
          }
          const audioBlob = new Blob([bytes], { type: "audio/mpeg" });
          const audioUrl = URL.createObjectURL(audioBlob);
          audio.src = audioUrl;
          audio.style.display = "block";
          audio.play();

          // üëâ Render script preview
          const lines = script.split("\n").filter((line) => line.trim());
          previewDiv.innerHTML = lines
            .map(
              (line) =>
                `<div class="line"><div class="bubble">${line}</div></div>`
            )
            .join("");
        } catch (err) {
          loading.style.display = "none";
          alert("‚ùå Error: " + err.message);
          console.error(err);
        }
      }

      function showScriptInput() {
        document.getElementById("dialogueWrapper").style.display = "block";
        document.getElementById("editScriptBtn").style.display = "none";
      }

      async function generateIELTSTable() {
        const text = document.getElementById("dialogueBox").value.trim();
        if (!text) return alert("Please enter some dialogue first!");

        const loading = document.getElementById("loadingMsg");
        loading.style.display = "block";

        const res = await fetch(
          "https://ielts-part1.onrender.com/api/generate-table",
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ script: text }),
            mode: "cors",
          }
        );

        loading.style.display = "none";

        const container = document.getElementById("ieltsTable");
        if (res.ok) {
          const { html } = await res.json();
          container.innerHTML = html;
        } else {
          container.innerHTML =
            "<p style='color:red'>‚ùå Failed to generate table.</p>";
        }
      }
    </script>
  </body>
</html>
